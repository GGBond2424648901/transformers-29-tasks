# 🎥 姿态估计实时检测使用说明

## 📖 功能介绍

这是一个支持**摄像头实时检测**和**视频文件检测**的姿态估计系统，可以：

- 📹 **摄像头实时检测**：打开电脑摄像头，实时显示骨骼关键点
- 🎬 **视频文件检测**：上传视频文件，逐帧进行姿态估计
- 👥 **多人检测**：使用YOLO准确统计人数
- 🦴 **骨骼可视化**：使用OpenPose绘制17个关键点和骨骼结构
- 💾 **保存功能**：支持截图和视频保存

## 🚀 快速开始

### 安装依赖

**重要：必须按以下顺序安装，避免版本冲突！**

```bash
# 1. 先安装NumPy 1.x版本（必须！）
pip install "numpy<2"

# 2. 安装OpenCV（GUI版本，指定版本避免冲突）
pip install opencv-python==4.8.1.78

# 3. 安装YOLO和OpenPose
pip install ultralytics
pip install controlnet-aux
```

**验证安装**:
```bash
# 检查NumPy版本（应该是1.26.4）
python -c "import numpy; print(numpy.__version__)"

# 检查OpenCV版本（应该是4.8.1.78）
python -c "import cv2; print(cv2.__version__)"
```

### 启动程序

```bash
D:\aaaalokda\envs\myenv\python.exe "姿态估计实时检测.py"
```

### 选择模式

程序启动后会显示菜单：

```
选择检测模式：
1. 摄像头实时检测
2. 视频文件检测
3. 退出
```

## 📹 模式1：摄像头实时检测

### 功能说明

- 打开电脑默认摄像头
- 实时显示姿态检测结果
- 显示FPS和检测到的人数

### 操作按键

| 按键 | 功能 |
|------|------|
| `Q` | 退出检测 |
| `S` | 截图保存 |
| `P` | 暂停/继续 |

### 使用步骤

1. 选择 `1` 进入摄像头模式
2. 等待摄像头启动
3. 对着摄像头做各种动作
4. 按 `S` 可以截图保存当前画面
5. 按 `Q` 退出

### 截图保存

截图会自动保存为：`pose_capture_时间戳.jpg`

## 🎬 模式2：视频文件检测

### 功能说明

- 支持常见视频格式（MP4、AVI、MOV等）
- 逐帧进行姿态检测
- 可选择保存处理后的视频

### 操作按键

| 按键 | 功能 |
|------|------|
| `Q` | 退出检测 |
| `P` | 暂停/继续 |
| `→` | 快进10帧 |
| `←` | 后退10帧 |

### 使用步骤

1. 选择 `2` 进入视频文件模式
2. 输入视频文件路径（可以拖拽文件到终端）
3. 选择是否保存处理后的视频（y/n）
4. 等待处理完成

### 视频保存

如果选择保存，输出视频会保存为：`pose_output_时间戳.mp4`

## 📊 显示信息

### 摄像头模式

- **FPS**: 每秒处理帧数
- **People**: 检测到的人数
- **操作提示**: 底部显示按键说明

### 视频模式

- **Frame**: 当前帧/总帧数（进度百分比）
- **People**: 检测到的人数

## ⚙️ 技术细节

### 检测流程

```
读取帧 → YOLO检测人数 → OpenPose生成骨骼 → 叠加显示 → 保存/显示
```

### 性能优化

1. **分辨率调整**: OpenPose使用384x384分辨率，平衡速度和精度
2. **YOLO Nano**: 使用YOLOv8n模型，速度最快
3. **跳帧处理**: 可以通过修改代码实现跳帧以提高速度

### 模型说明

- **YOLO**: 用于人体检测和计数
- **OpenPose**: 用于骨骼关键点检测
- **17个关键点**: 鼻子、双眼、双耳、双肩、双肘、双腕、双髋、双膝、双踝

## 🎯 应用场景

### 健身指导

- 实时监测运动姿态
- 记录训练视频
- 分析动作规范性

### 动作捕捉

- 游戏开发
- 动画制作
- 虚拟现实

### 安全监控

- 人员计数
- 行为分析
- 异常检测

### 体育分析

- 运动员姿态分析
- 比赛视频分析
- 技术动作研究

## 💡 使用技巧

### 提高检测精度

1. **光线充足**: 确保环境光线良好
2. **背景简单**: 避免复杂背景干扰
3. **全身入镜**: 尽量让整个身体都在画面中
4. **正面或侧面**: 这两个角度检测效果最好

### 提高处理速度

1. **降低分辨率**: 修改 `detect_resolution` 参数
2. **跳帧处理**: 不是每帧都检测
3. **关闭保存**: 不保存视频可以提高速度

### 批量处理

可以修改代码实现批量处理多个视频文件：

```python
video_files = ['video1.mp4', 'video2.mp4', 'video3.mp4']
for video_path in video_files:
    # 处理每个视频
    pass
```

## ⚠️ 注意事项

### 摄像头权限

- Windows可能需要在设置中允许应用访问摄像头
- 确保没有其他程序占用摄像头

### 性能要求

- **推荐配置**: 
  - GPU: NVIDIA显卡（支持CUDA）
  - 内存: 8GB以上
  - CPU: i5或以上

- **最低配置**:
  - CPU: i3或以上
  - 内存: 4GB以上
  - 注意：CPU模式会比较慢

### 视频格式

- 支持: MP4、AVI、MOV、MKV等常见格式
- 编码: H.264、MPEG-4等
- 如果视频无法打开，尝试用格式工厂转换为MP4

## 🔧 常见问题

### Q1: OpenCV GUI错误？

**错误信息**:
```
cv2.error: The function is not implemented. Rebuild the library with Windows, GTK+ 2.x or Cocoa support
```

**原因**: 安装了 `opencv-python-headless`（无GUI版本）或版本冲突

**解决方案**:
```bash
# 1. 卸载所有OpenCV版本
pip uninstall -y opencv-python opencv-python-headless

# 2. 安装GUI版本（指定版本避免NumPy冲突）
pip install opencv-python==4.8.1.78

# 3. 确保NumPy是1.x版本
pip install "numpy<2"
```

**验证安装**:
```bash
python -c "import cv2; print(cv2.__version__)"
```

### Q2: 摄像头打不开？

**A**: 
1. 检查摄像头是否被其他程序占用
2. 尝试修改代码中的摄像头索引：`cv2.VideoCapture(1)` 或 `cv2.VideoCapture(2)`
3. 检查Windows隐私设置中的摄像头权限

### Q3: NumPy版本冲突？

**错误信息**:
```
ERROR: opencv-python requires numpy>=2
```

**解决方案**:
```bash
# 强制安装NumPy 1.x（必须！）
pip install "numpy<2" --force-reinstall

# 然后安装兼容的OpenCV版本
pip install opencv-python==4.8.1.78
```

**重要**: 本项目必须使用NumPy 1.x，因为其他依赖（如某些transformers模型）不支持NumPy 2.x

### Q4: 检测速度很慢？

**A**:
1. 确保使用GPU加速（安装CUDA版本的PyTorch）
2. 降低检测分辨率
3. 实现跳帧处理

### Q5: 检测不准确？

**A**:
1. 改善光线条件
2. 确保人物完整入镜
3. 避免复杂背景
4. 尝试正面或侧面角度

### Q6: 视频保存失败？

**A**:
1. 检查磁盘空间
2. 确保有写入权限
3. 尝试更换输出路径

### Q7: YOLO或OpenPose加载失败？

**错误信息**:
```
⚠️ YOLO加载失败
⚠️ OpenPose加载失败
```

**解决方案**:
```bash
# 安装YOLO
pip install ultralytics

# 安装OpenPose
pip install controlnet-aux

# 确保网络畅通（模型会自动下载）
```

## 📚 扩展功能

### 添加姿态分析

可以基于关键点坐标计算：
- 关节角度
- 身体倾斜度
- 运动轨迹
- 动作识别

### 添加数据记录

记录每帧的检测数据：
- 人数统计
- 关键点坐标
- 时间戳
- 导出为CSV或JSON

### 添加警报功能

当检测到特定姿态时触发警报：
- 跌倒检测
- 异常姿态
- 人数超限

## 🔗 相关资源

- [OpenPose论文](https://arxiv.org/abs/1812.08008)
- [YOLOv8文档](https://docs.ultralytics.com/)
- [OpenCV文档](https://docs.opencv.org/)

## 📝 更新日志

**v1.0** (2026-02-01)
- ✅ 支持摄像头实时检测
- ✅ 支持视频文件检测
- ✅ 集成YOLO人体检测
- ✅ 集成OpenPose姿态估计
- ✅ 支持截图和视频保存
- ✅ 支持暂停、快进、后退

---

**祝你使用愉快！** 🎉

# 姿态估计实时检测 - 依赖安装指南 📦

## ⚠️ 重要提示

**必须按照以下顺序安装，否则会出现版本冲突！**

## 🔧 安装步骤

### 步骤1: 安装NumPy 1.x

```bash
pip install "numpy<2"
```

**为什么必须是1.x版本？**
- 本项目的其他依赖（transformers、某些模型）不支持NumPy 2.x
- OpenCV 4.13.x要求NumPy 2.x，但我们使用4.8.1.78版本避免冲突

**验证**:
```bash
python -c "import numpy; print(numpy.__version__)"
# 应该显示: 1.26.4
```

### 步骤2: 安装OpenCV（GUI版本）

```bash
pip install opencv-python==4.8.1.78
```

**为什么指定这个版本？**
- 4.8.1.78兼容NumPy 1.x
- 包含GUI支持（cv2.imshow等函数）
- 避免与controlnet-aux的opencv-python-headless冲突

**验证**:
```bash
python -c "import cv2; print(cv2.__version__)"
# 应该显示: 4.8.1.78
```

### 步骤3: 安装YOLO

```bash
pip install ultralytics
```

**功能**: 用于人体检测和计数

**注意**: ultralytics会尝试patch OpenCV的imshow函数，我们在代码中已经处理了这个问题

### 步骤4: 安装OpenPose

```bash
pip install controlnet-aux
```

**功能**: 用于骨骼关键点检测

**注意**: 这个包依赖opencv-python-headless，但我们已经安装了opencv-python，两者可以共存

## ✅ 完整安装命令

如果你想一次性安装所有依赖，按顺序执行：

```bash
pip install "numpy<2"
pip install opencv-python==4.8.1.78
pip install ultralytics
pip install controlnet-aux
```

## 🔍 验证安装

运行以下命令检查所有依赖是否正确安装：

```bash
python -c "import numpy, cv2, ultralytics; from controlnet_aux import OpenposeDetector; print('✅ 所有依赖安装成功！')"
```

如果没有报错，说明安装成功！

## 🐛 常见安装问题

### 问题1: NumPy自动升级到2.x

**症状**:
```
Successfully installed numpy-2.4.2
```

**解决**:
```bash
pip install "numpy<2" --force-reinstall
```

### 问题2: OpenCV GUI错误

**症状**:
```
cv2.error: The function is not implemented
```

**原因**: 安装了opencv-python-headless或版本不对

**解决**:
```bash
pip uninstall -y opencv-python opencv-python-headless
pip install opencv-python==4.8.1.78
```

### 问题3: 依赖冲突警告

**症状**:
```
ERROR: pip's dependency resolver does not currently take into account...
controlnet-aux requires opencv-python-headless, which is not installed.
```

**说明**: 这是警告，不是错误。controlnet-aux要求opencv-python-headless，但opencv-python提供了相同的功能（还多了GUI支持），所以可以忽略这个警告。

### 问题4: YOLO模型下载失败

**症状**:
```
Downloading yolov8n.pt failed
```

**解决**:
1. 检查网络连接
2. 手动下载模型：https://github.com/ultralytics/assets/releases/download/v8.4.0/yolov8n.pt
3. 将下载的文件放到项目目录

### 问题5: OpenPose模型下载失败

**症状**:
```
Error downloading lllyasviel/ControlNet
```

**解决**:
1. 检查网络连接
2. 确保可以访问Hugging Face
3. 设置代理（如果需要）：
```bash
export HF_ENDPOINT=https://hf-mirror.com
```

## 📋 依赖版本总结

| 包名 | 版本 | 说明 |
|------|------|------|
| numpy | <2 (1.26.4) | 必须1.x版本 |
| opencv-python | 4.8.1.78 | GUI版本，兼容NumPy 1.x |
| ultralytics | latest | YOLO模型 |
| controlnet-aux | latest | OpenPose模型 |
| torch | latest | PyTorch（如已安装） |
| pillow | latest | 图像处理（通常已安装） |

## 🎯 环境信息

- **Python**: 3.11
- **操作系统**: Windows
- **GPU**: NVIDIA GeForce RTX 3070 Laptop (8GB VRAM)
- **Python路径**: `D:\aaaalokda\envs\myenv\python.exe`
- **模型缓存**: `D:\transformers训练\transformers-main\预训练模型下载处`

## 🔄 重新安装（清理环境）

如果遇到无法解决的问题，可以完全重新安装：

```bash
# 1. 卸载所有相关包
pip uninstall -y numpy opencv-python opencv-python-headless ultralytics controlnet-aux

# 2. 按顺序重新安装
pip install "numpy<2"
pip install opencv-python==4.8.1.78
pip install ultralytics
pip install controlnet-aux

# 3. 验证
python -c "import numpy, cv2, ultralytics; from controlnet_aux import OpenposeDetector; print('✅ 安装成功！')"
```

## 📞 获取帮助

如果安装过程中遇到问题：

1. 检查Python版本（应该是3.8+）
2. 检查pip版本（`pip --version`）
3. 尝试升级pip（`pip install --upgrade pip`）
4. 查看完整错误信息
5. 参考本文档的常见问题部分

---

**安装完成后，请查看 `实时检测使用说明.md` 了解如何使用程序！** 🎉
